{% extends "base.html" %}

{% block content %}
<div class="card mb-4 border-warning">
    <div class="card-body d-flex flex-column align-items-start">
        <h5 class="card-title text-warning">üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º</h5>
        <form method="post" action="/web/user/refresh-token" class="mb-3">
            <button type="submit" class="btn btn-sm btn-outline-warning px-4"
                onclick="return confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω? –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—É–¥–µ—Ç –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á.');">
                –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
            </button>
        </form>

        <div>
            <p class="mb-1">–¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω: <code class="bg-light p-1 text-break">{{ user.token }}</code></p>
            <small class="text-muted">–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±—É–¥–µ—Ç –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π
                –∫–ª—é—á.</small>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h4>
    </div>

    <div class="card-body pt-3 pb-0">
        <form method="post" action="/web/user/update-timeout">
            <div class="input-group input-group-sm" style="max-width: 200px;">
                <span class="input-group-text">–¢–∞–π–º–∞—É—Ç (—Å–µ–∫.)</span>
                <input type="number" name="timeout" class="form-control" value="{{ user.heartbeat_timeout }}">
                <button class="btn btn-outline-primary" type="submit">‚úì</button>
            </div>
            <small class="text-muted d-block mt-1 mb-2">–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–∫–ª–∏–∫–∞ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</small>
        </form>
    </div>

    <div class="card-body">
        {% if devices %}
        <div class="table-responsive"
            style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
            <table class="table table-hover align-middle mb-0" style="min-width: 800px;">
                <thead
                    style="position: sticky; top: 0; background-color: white; z-index: 10; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);">
                    <tr>
                        <th style="width: 20%;">ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                        <th style="width: 25%;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th style="width: 15%;">–°—Ç–∞—Ç—É—Å</th>
                        <th style="width: 40%; text-align: right;" class="pe-4">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dev in devices %}
                    <tr>
                        <td><code>{{ dev.device_id }}</code></td>
                        <td>{{ dev.description or "‚Äî" }}</td>
                        <td>
                            {% if dev.status == "blocked" %}
                            <span class="badge bg-secondary">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                            {% elif dev.status == "unverified" %}
                            <span class="badge bg-warning text-dark">–ù–æ–≤–æ–µ</span>
                            {% else %}
                            {% if dev.last_heartbeat %}
                            {% set diff = (now - dev.last_heartbeat).total_seconds() %}
                            {% if diff < user.heartbeat_timeout %} <span class="badge bg-success"
                                title="–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç: {{ dev.last_heartbeat.strftime('%d.%m.%Y %H:%M:%S') }}">‚óè Online</span>
                                {% else %}
                                <span class="badge bg-danger"
                                    title="–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç —Å: {{ dev.last_heartbeat.strftime('%d.%m.%Y %H:%M:%S') }}">X
                                    Offline</span>
                                {% endif %}
                                {% else %}
                                <span class="badge bg-danger">X Offline (–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö)</span>
                                {% endif %}
                                {% endif %}
                        </td>
                        <td class="text-nowrap">
                            <div class="d-flex gap-2 justify-content-end pe-2">
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#playlistModal{{ dev.id }}">
                                    üé¨ –ü–ª–µ–π–ª–∏—Å—Ç
                                </button>

                                <div class="vr" style="height: 24px; opacity: 0.5; align-self: center;"></div>

                                <form method="post" action="/web/device/action" class="d-flex gap-1 m-0">
                                    <input type="hidden" name="device_id" value="{{ dev.id }}">

                                    {% if dev.status == 'unverified' or dev.status == 'blocked' %}
                                    <button name="action" value="activate"
                                        class="btn btn-sm btn-success">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                                    {% endif %}

                                    {% if dev.status == 'active' %}
                                    <button name="action" value="block"
                                        class="btn btn-sm btn-warning">–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                    {% endif %}

                                    <button name="action" value="delete" class="btn btn-sm btn-danger"
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ {{ dev.device_id }}, {{ dev.description }}?');">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted p-3">–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üé¨ –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç</h4>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
            + –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
        </button>
    </div>
    <div class="card-body">
        <div class="row">
            {% for file in files %}
            <div class="col-12 col-md-4 mb-3">
                <div class="card h-100 shadow-sm">
                    <video src="/web/stream/{{ file.file_id }}" class="card-img-top" controls
                        style="height: 180px; object-fit: cover; background: #000;"></video>
                    <div class="card-body">
                        <h6 class="card-title text-truncate" title="{{ file.description }}">{{ file.description or "–ë–µ–∑
                            –æ–ø–∏—Å–∞–Ω–∏—è" }}</h6>
                        <small class="text-muted d-block mb-2">ID: {{ file.file_id }}</small>
                        <form method="post" action="/web/file/delete">
                            <input type="hidden" name="file_id" value="{{ file.file_id }}">
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100"
                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?');">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <p class="text-muted w-100 text-center py-4">–§–∞–π–ª–æ–≤ –Ω–µ—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ.</p>
            {% endfor %}
        </div>
    </div>
</div>

{% for dev in devices %}
<div class="modal fade" id="playlistModal{{ dev.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <form method="post" action="/web/device/update-playlist" class="modal-content bg-white text-dark shadow">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center w-100">
                    <span class="text-wrap" style="word-break: break-word; line-height: 1.2;">
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {{ dev.description }} ({{ dev.device_id }})
                    </span>
                </h5>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <input type="hidden" name="device_id" value="{{ dev.id }}">

                <div class="p-3 bg-light border-bottom">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">üîç</span>
                        <input type="text" class="form-control border-start-0 ps-0 playlist-search"
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID..." data-device-id="{{ dev.id }}"
                            onkeyup="filterPlaylist('{{ dev.id }}')">
                    </div>
                </div>

                <div class="list-group list-group-flush playlist-items-{{ dev.id }}">
                    {% for file in files %}
                    <label
                        class="list-group-item list-group-item-action d-flex align-items-start gap-3 py-3 playlist-item">
                        <div class="pt-1">
                            <input class="form-check-input flex-shrink-0" type="checkbox" name="selected_files"
                                value="{{ file.id }}" {% if file in dev.files %}checked{% endif %}>
                        </div>

                        <div class="d-flex flex-column min-width-0 w-100">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <strong class="text-dark text-wrap search-title" style="word-break: break-word;">
                                    {{ file.description or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
                                </strong>
                                <span class="badge bg-light text-muted border ms-2 flex-shrink-0">MP4</span>
                            </div>
                            <code class="small text-muted text-truncate search-id">{{ file.file_id }}</code>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" action="/web/file/upload" enctype="multipart/form-data"
            class="modal-content bg-white text-dark">
            <div class="modal-header">
                <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" name="description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">–§–∞–π–ª (MP4)</label>
                    <input type="file" name="file" class="form-control" accept="video/mp4" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ –º–æ–¥–∞–ª–∫–µ */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 0.5rem;
        }

        .list-group-item {
            padding-left: 10px;
            padding-right: 10px;
        }
    }
</style>

<script>
    function filterPlaylist(deviceId) {
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        const input = document.querySelector(`.playlist-search[data-device-id="${deviceId}"]`);
        const filter = input.value.toLowerCase();

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const container = document.querySelector(`.playlist-items-${deviceId}`);
        const items = container.getElementsByClassName('playlist-item');

        for (let i = 0; i < items.length; i++) {
            const title = items[i].querySelector('.search-title').innerText.toLowerCase();
            const fileId = items[i].querySelector('.search-id').innerText.toLowerCase();

            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π –∏–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏/ID
            if (title.includes(filter) || fileId.includes(filter)) {
                items[i].style.display = ""; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                items[i].classList.add('d-flex'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–ª–µ–∫—Å-—Å—Ç–∏–ª–∏
            } else {
                items[i].style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º
                items[i].classList.remove('d-flex');
            }
        }
    }

    // –°–±—Ä–æ—Å –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.addEventListener('hidden.bs.modal', function (event) {
        const searchInputs = document.querySelectorAll('.playlist-search');
        searchInputs.forEach(input => {
            input.value = '';
            const deviceId = input.getAttribute('data-device-id');
            filterPlaylist(deviceId);
        });
    });
</script>

{% endblock %}